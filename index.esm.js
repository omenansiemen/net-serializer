Object.defineProperty(exports,"__esModule",{value:!0}),exports.setTextHandler=exports.unpack=exports.pack=exports.calculateBufferSize=exports.Types=void 0;var e,t=function(e){return"boolean"==typeof e},n=function(e){return null!==e&&"object"==typeof e},r=function(e){return"object"==typeof e&&Array.isArray(e)},i=function(e){return r(e)&&(1===e.length||2===e.length)},f=function(e){return"number"==typeof e};!function(e){e.int8="int8",e.uint8="uint8",e.int16="int16",e.uint16="uint16",e.int32="int32",e.uint32="uint32",e.float32="float32",e.float64="float64",e.boolean="boolean",e.string8="string8",e.string16="string16",e.string="string"}(e=exports.Types||(exports.Types={}));var o=function(e){return"string"==typeof e.type};function s(y,u,a){var v,c;if(r(y)&&i(u)){var b={type:null!==(c=null===(v=u[1])||void 0===v?void 0:v.lengthType)&&void 0!==c?c:e.uint32};if(a.byteOffset+=p(a,b,y.length),o(u[0]))for(var O=0,d=y;O<d.length;O++){var w=d[O];a.byteOffset+=p(a,u[0],w)}else for(var x=0,h=y;x<h.length;x++){s(w=h[x],u[0],a)}}else for(var k=0,T=Object.keys(u);k<T.length;k++){var m=T[k],U=y[m],B=u[m];if(n(U))o(B)&&B.compress?a.byteOffset+=p(a,B,B.compress.pack(U)):s(U,B,a);else if(f(U)||t(U))a.byteOffset+=p(a,B,U);else{if("string"!=typeof U){var E="";throw void 0===U&&(E="Template property "+m+", is not found from data "+y),"function"==typeof a.onErrorCallback&&a.onErrorCallback(E),Error(E)}var I=g(U),z={type:l(B.type)};a.byteOffset+=p(a,z,I.byteLength),p(a,B,I),a.byteOffset+=I.byteLength}}}exports.calculateBufferSize=function(s,p,u){var a,v;if(void 0===u&&(u=0),r(s)&&i(p)){var c={type:null!==(v=null===(a=p[1])||void 0===a?void 0:a.lengthType)&&void 0!==v?v:e.uint32};if(u+=y(c,s.length),s.length>0)if(o(p[0]))u+=y(p[0])*s.length;else for(var b=0,O=s;b<O.length;b++){var d=O[b];u+=exports.calculateBufferSize(d,p[0])}}else Object.keys(p).forEach((function(e){var r=s[e],i=p[e];if(n(r))o(i)&&i.compress?u+=y(i,r):u+=exports.calculateBufferSize(r,i);else if(f(r)||t(r))u+=y(i,r);else if("string"==typeof r){var a=g(r),v=l(i.type);u+=y({type:v},a.byteLength),u+=a.byteLength}}));return u};var l=function(t){return t===e.string8?e.uint8:t===e.string16?e.uint16:e.uint32};function p(t,n,r){var i=0;return f(n.multiplier)&&f(r)&&(r*=n.multiplier),n.type===e.uint8?(n.preventOverflow&&(r=r<0?0:r>255?255:r),t.view.setUint8(t.byteOffset,r),i=1):n.type===e.int8?(n.preventOverflow&&(r=r<-128?-128:r>127?127:r),t.view.setInt8(t.byteOffset,r),i=1):n.type===e.boolean?(t.view.setInt8(t.byteOffset,!1===r?0:1),i=1):n.type===e.uint16?(n.preventOverflow&&(r=r<0?0:r>65535?65535:r),t.view.setUint16(t.byteOffset,r),i=2):n.type===e.int16?(n.preventOverflow&&(r=r<-32768?-32768:r>32767?32767:r),t.view.setInt16(t.byteOffset,r),i=2):n.type===e.uint32?(n.preventOverflow&&(r=r<0?0:r>4294967295?4294967295:r),t.view.setUint32(t.byteOffset,r),i=4):n.type===e.int32?(n.preventOverflow&&(r=r<-2147483648?-2147483648:r>2147483647?2147483647:r),t.view.setInt32(t.byteOffset,r),i=4):n.type===e.float32?(t.view.setFloat32(t.byteOffset,r),i=4):n.type===e.float64?(t.view.setFloat64(t.byteOffset,r),i=8):(n.type!==e.string8&&n.type!==e.string16&&n.type!==e.string||r instanceof Uint8Array&&r.forEach((function(e,n){return t.view.setUint8(n+t.byteOffset,e)})),i=r),i}function y(t,n){var r=0;return t.type===e.int8||t.type===e.uint8||t.type===e.boolean?r=1:t.type===e.int16||t.type===e.uint16?r=2:t.type===e.int32||t.type===e.uint32||t.type===e.float32?r=4:t.type===e.string8||t.type===e.string16||t.type===e.string?r=n instanceof Uint8Array?n.byteLength:t.type===e.string8?1:t.type===e.string16?2:4:t.type===e.float64&&(r=8),r}function u(t,n,r){var s,l,p,y,v;if(i(n)){v=[];for(var c=a(t,{type:null!==(l=null===(s=n[1])||void 0===s?void 0:s.lengthType)&&void 0!==l?l:e.uint32},r),b=null!==(y=null===(p=n[1])||void 0===p?void 0:p.unpackCallback)&&void 0!==y?y:null,g=0;g<(f(c)?c:0);g++){var O=u(t,n[0],r);b?null!=(O=b(O))&&v.push(O):v.push(O)}}else o(n)?v=a(t,n,r):(v={},Object.keys(n).forEach((function(e){var i=n[e];if(o(i))if(i.compress){var f=a(t,i,r);v[e]=i.compress.unpack(f)}else v[e]=a(t,i,r);else v[e]=u(t,i,r)})));return v}function a(t,n,r){var i,o=0;if(n.type===e.uint8)i=r.view.getUint8(r.byteOffset),o=1;else if(n.type===e.int8)i=r.view.getInt8(r.byteOffset),o=1;else if(n.type===e.boolean)i=0!==r.view.getInt8(r.byteOffset),o=1;else if(n.type===e.uint16)i=r.view.getUint16(r.byteOffset),o=2;else if(n.type===e.int16)i=r.view.getInt16(r.byteOffset),o=2;else if(n.type===e.uint32)i=r.view.getUint32(r.byteOffset),o=4;else if(n.type===e.int32)i=r.view.getInt32(r.byteOffset),o=4;else if(n.type===e.float32)i=r.view.getFloat32(r.byteOffset),o=4;else if(n.type===e.float64)i=r.view.getFloat64(r.byteOffset),o=8;else if(n.type===e.string8||n.type===e.string16||n.type===e.string){o=y(n);var s=void 0,l=void 0;n.type===e.string8?(o+=s=r.view.getUint8(r.byteOffset),l=r.byteOffset+1):n.type===e.string16?(o+=s=r.view.getUint16(r.byteOffset),l=r.byteOffset+2):(o+=s=r.view.getUint32(r.byteOffset),l=r.byteOffset+4);var p=l+s;i=v(t.slice(l,p))}return f(n.multiplier)&&f(i)&&(i/=n.multiplier),r.byteOffset+=o,i}exports.pack=function(e,t,n){void 0===n&&(n={});var r,i=n.sharedBuffer,f=n.returnCopy,o=void 0!==f&&f,l=n.freeBytes,p=void 0===l?0:l,y=n.bufferSizeInBytes,u=null!=y?y:exports.calculateBufferSize(e,t);return s(e,t,{byteOffset:0,buffer:r=void 0!==i?i:new ArrayBuffer(u+p),view:new DataView(r),onErrorCallback:n.onErrorCallback}),void 0!==i&&o?r.slice(0,u):r},exports.unpack=function(e,t){return u(e,t,{byteOffset:0,view:new DataView(e)})};var v,c,b=function(e){return function(t){return e.decode(t)}};"function"==typeof TextDecoder&&(c=new TextDecoder,v=b(c));var g,O,d=function(e){return function(t){return e.encode(t)}};"function"==typeof TextEncoder&&(O=new TextEncoder,g=d(O)),exports.setTextHandler=function(e){g=d(e),v=b(e)};var w={pack:exports.pack,unpack:exports.unpack,utils:{setTextHandler:exports.setTextHandler,calculateBufferSize:exports.calculateBufferSize,Types:e}};exports.default=w;
