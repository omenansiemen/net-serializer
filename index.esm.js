Object.defineProperty(exports,"__esModule",{value:!0}),exports.setTextHandler=exports.unpack=exports.pack=exports.calculateBufferSize=exports.Types=void 0;var e,t=function(e){return"boolean"==typeof e},n=function(e){return null!==e&&"object"==typeof e},r=function(e){return"object"==typeof e&&Array.isArray(e)},i=function(e){return r(e)&&(1===e.length||2===e.length)},f=function(e){return"number"==typeof e};!function(e){e.int8="int8",e.uint8="uint8",e.int16="int16",e.uint16="uint16",e.int32="int32",e.uint32="uint32",e.float32="float32",e.float64="float64",e.boolean="boolean",e.string8="string8",e.string16="string16",e.string="string"}(e=exports.Types||(exports.Types={}));var o=function(e){return"string"==typeof e.type};exports.calculateBufferSize=function(o,l,s){var a,y;if(void 0===s&&(s=0),r(o)&&i(l)){var c={type:null!==(y=null===(a=l[1])||void 0===a?void 0:a.lengthType)&&void 0!==y?y:e.uint32};s+=p(c,o.length),o.length>0&&(s+=exports.calculateBufferSize(o[0],l[0])*o.length)}else Object.keys(l).forEach((function(e){var r=o[e],i=l[e];if(n(r))s+=exports.calculateBufferSize(r,i);else if(f(r)||t(r))s+=p(i,r);else if("string"==typeof r){var a=g(r),y=u(i.type);s+=p({type:y},a.byteLength),s+=a.byteLength}}));return s};var u=function(t){return t===e.string8?e.uint8:t===e.string16?e.uint16:e.uint32};function l(e,t,n){s({metaValue:t,refObject:e,value:n})}var s=function(t){var n=t.metaValue,r=t.refObject,i=t.value,o=p(n,i),u=new DataView(r.buffer,r.byteOffset,o);return f(n.multiplier)&&f(i)&&(i*=n.multiplier),n.type===e.uint8?(n.preventOverflow&&(i=i<0?0:i>255?255:i),u.setUint8(0,i)):n.type===e.int8?(n.preventOverflow&&(i=i<-128?-128:i>127?127:i),u.setInt8(0,i)):n.type===e.boolean?u.setInt8(0,!1===i?0:1):n.type===e.uint16?(n.preventOverflow&&(i=i<0?0:i>65535?65535:i),u.setUint16(0,i)):n.type===e.int16?(n.preventOverflow&&(i=i<-32768?-32768:i>32767?32767:i),u.setInt16(0,i)):n.type===e.uint32?(n.preventOverflow&&(i=i<0?0:i>4294967295?4294967295:i),u.setUint32(0,i)):n.type===e.int32?(n.preventOverflow&&(i=i<-2147483648?-2147483648:i>2147483647?2147483647:i),u.setInt32(0,i)):n.type===e.float32?u.setFloat32(0,i):n.type===e.float64?u.setFloat64(0,i):n.type!==e.string8&&n.type!==e.string16&&n.type!==e.string||i instanceof Uint8Array&&i.forEach((function(e,t){return u.setUint8(t,e)})),o};function p(t,n){var r=0;if(t.type===e.int8||t.type===e.uint8||t.type===e.boolean)r=1;else if(t.type===e.int16||t.type===e.uint16)r=2;else if(t.type===e.int32||t.type===e.uint32||t.type===e.float32)r=4;else if(t.type===e.string8||t.type===e.string16||t.type===e.string)r=n instanceof Uint8Array?n.byteLength:t.type===e.string8?1:t.type===e.string16?2:4;else{if(t.type!==e.float64)throw Error("Unknown type: "+t.type);r=8}return r}function a(t,n,r){var i,o=p(n),u=new DataView(t,r,o);if(n.type===e.uint8)i=u.getUint8(0);else if(n.type===e.int8)i=u.getInt8(0);else if(n.type===e.uint16)i=u.getUint16(0);else if(n.type===e.int16)i=u.getInt16(0);else if(n.type===e.uint32)i=u.getUint32(0);else if(n.type===e.int32)i=u.getInt32(0);else if(n.type===e.float32)i=u.getFloat32(0);else if(n.type===e.float64)i=u.getFloat64(0);else if(n.type===e.boolean)i=0!==u.getInt8(0);else{if(n.type!==e.string8&&n.type!==e.string16&&n.type!==e.string)throw Error("Unknown metaValue.type "+n);var l=void 0,s=void 0;n.type===e.string8?(o+=l=u.getUint8(0),s=r+1):n.type===e.string16?(o+=l=u.getUint16(0),s=r+2):(o+=l=u.getUint32(0),s=r+4);var a=s+l;i=y(t.slice(s,a))}return f(n.multiplier)&&f(i)&&(i/=n.multiplier),{value:i,byteOffset:r+o}}exports.pack=function(o,s,a){void 0===a&&(a={});var y,c=a.sharedBuffer,v=a.returnCopy,b=void 0!==v&&v,d=a.freeBytes,O=void 0===d?0:d,x=a.bufferSizeInBytes,h=null!=x?x:exports.calculateBufferSize(o,s);return function o(s,a,y){var c,v;if(r(s)&&i(a)){var b={type:null!==(v=null===(c=a[1])||void 0===c?void 0:c.lengthType)&&void 0!==v?v:e.uint32};l(y,b,s.length),y.byteOffset+=p(b,s.length),s.forEach((function(e){o(e,a[0],y)}))}else Object.keys(a).forEach((function(e){var r=s[e],i=a[e];if(n(r))o(r,i,y);else if(f(r)||t(r))l(y,i,r),y.byteOffset+=p(i,r);else if("string"==typeof r){var c=g(r),v={type:u(i.type)};l(y,v,c.byteLength),y.byteOffset+=p(v,c.byteLength),l(y,i,c),y.byteOffset+=c.byteLength}}))}(o,s,{byteOffset:0,buffer:y=void 0!==c?c:new ArrayBuffer(h+O)}),void 0!==c&&b?y.slice(0,h):y},exports.unpack=function(t,n){return function t(n,r,f){var u,l,s,p,y;if(i(r)){y=[];var c=a(n,{type:null!==(l=null===(u=r[1])||void 0===u?void 0:u.lengthType)&&void 0!==l?l:e.uint32},f.byteOffset),v=c.value,g=c.byteOffset;f.byteOffset=g;for(var b=null!==(p=null===(s=r[1])||void 0===s?void 0:s.unpackCallback)&&void 0!==p?p:null,d=0;d<v;d++){var O=t(n,r[0],f);b?null!=(O=b(O))&&y.push(O):y.push(O)}}else if(y={},o(r)){var x=a(n,r,f.byteOffset),h=x.value;g=x.byteOffset,f.byteOffset=g,y=h}else Object.keys(r).forEach((function(e){if(o(r[e])){var i=a(n,r[e],f.byteOffset),u=i.value,l=i.byteOffset;f.byteOffset=l,y[e]=u}else{var s=t(n,r[e],f);y[e]=s}}));return y}(t,n,{byteOffset:0})};var y,c,v=function(e){return function(t){return e.decode(t)}};"function"==typeof TextDecoder&&(c=new TextDecoder,y=v(c));var g,b,d=function(e){return function(t){return e.encode(t)}};"function"==typeof TextEncoder&&(b=new TextEncoder,g=d(b)),exports.setTextHandler=function(e){g=d(e),y=v(e)};var O={pack:exports.pack,unpack:exports.unpack,utils:{setTextHandler:exports.setTextHandler,calculateBufferSize:exports.calculateBufferSize,Types:e}};exports.default=O;
