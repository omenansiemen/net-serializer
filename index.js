"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.setTextHandler=exports.unpack=exports.pack=exports.calculateBufferSize=exports.Types=exports.Limits=void 0;var e,t=function(e){return"boolean"==typeof e},n=function(e){return null!==e&&"object"==typeof e},i=function(e){return"object"==typeof e&&Array.isArray(e)},r=function(e){return i(e)&&(1===e.length||2===e.length)},f=function(e){return"number"==typeof e};exports.Limits={uint8Max:255,int8Min:-128,int8Max:127,uint16Max:65535,int16Min:-32768,int16Max:32767,uint32Max:4294967295,int32Min:-2147483648,int32Max:2147483647},function(e){e.int8="int8",e.uint8="uint8",e.int16="int16",e.uint16="uint16",e.int32="int32",e.uint32="uint32",e.float32="float32",e.float64="float64",e.boolean="boolean",e.string8="string8",e.string16="string16",e.string="string"}(e=exports.Types||(exports.Types={}));var o=function(e){return"string"==typeof e.type};function s(p,u,y){var c,v;if(y.callStack.push(p),i(p)&&r(u)){var b={type:null!==(v=null===(c=u[1])||void 0===c?void 0:c.lengthType)&&void 0!==v?v:e.uint32};if(y.byteOffset+=a(y,b,p.length),o(u[0]))for(var O=0,d=p;O<d.length;O++){var w=d[O];y.byteOffset+=a(y,u[0],w)}else for(var x=0,h=p;x<h.length;x++){s(w=h[x],u[0],y)}}else for(var k=0,m=Object.keys(u);k<m.length;k++){var T=m[k],S=p[T],U=u[T];if(n(S))o(U)&&U.compress?y.byteOffset+=a(y,U,U.compress.pack(S,y.callStack)):s(S,U,y);else if(f(S)||t(S))o(U)&&U.compress?y.byteOffset+=a(y,U,U.compress.pack(S,y.callStack)):y.byteOffset+=a(y,U,S);else{if("string"!=typeof S){var B="";throw void 0===S&&(B="Template property "+T+", is not found from data "+p+"."),"function"==typeof y.onErrorCallback&&y.onErrorCallback(B,y.callStack),Error(B)}var E=g(S),M={type:l(U.type)};y.byteOffset+=a(y,M,E.byteLength),a(y,U,E),y.byteOffset+=E.byteLength}}y.callStack.pop()}exports.calculateBufferSize=function(s,a,u){var y,c;if(void 0===u&&(u=0),i(s)&&r(a)){var v={type:null!==(c=null===(y=a[1])||void 0===y?void 0:y.lengthType)&&void 0!==c?c:e.uint32};if(u+=p(v,s.length),s.length>0)if(o(a[0]))u+=p(a[0])*s.length;else for(var b=0,O=s;b<O.length;b++){var d=O[b];u+=exports.calculateBufferSize(d,a[0])}}else Object.keys(a).forEach((function(e){var i=s[e],r=a[e];if(n(i))o(r)&&r.compress?u+=p(r,i):u+=exports.calculateBufferSize(i,r);else if(f(i)||t(i))u+=p(r,i);else if("string"==typeof i){var y=g(i),c=l(r.type);u+=p({type:c},y.byteLength),u+=y.byteLength}}));return u};var l=function(t){return t===e.string8?e.uint8:t===e.string16?e.uint16:e.uint32};function a(t,n,i){var r=0;return f(n.multiplier)&&f(i)&&(i*=n.multiplier),n.type===e.uint8?(n.preventOverflow&&(i=i<0?0:i>255?255:i),t.view.setUint8(t.byteOffset,i),r=1):n.type===e.int8?(n.preventOverflow&&(i=i<-128?-128:i>127?127:i),t.view.setInt8(t.byteOffset,i),r=1):n.type===e.boolean?(t.view.setInt8(t.byteOffset,!1===i?0:1),r=1):n.type===e.uint16?(n.preventOverflow&&(i=i<0?0:i>65535?65535:i),t.view.setUint16(t.byteOffset,i),r=2):n.type===e.int16?(n.preventOverflow&&(i=i<-32768?-32768:i>32767?32767:i),t.view.setInt16(t.byteOffset,i),r=2):n.type===e.uint32?(n.preventOverflow&&(i=i<0?0:i>4294967295?4294967295:i),t.view.setUint32(t.byteOffset,i),r=4):n.type===e.int32?(n.preventOverflow&&(i=i<-2147483648?-2147483648:i>2147483647?2147483647:i),t.view.setInt32(t.byteOffset,i),r=4):n.type===e.float32?(t.view.setFloat32(t.byteOffset,i),r=4):n.type===e.float64?(t.view.setFloat64(t.byteOffset,i),r=8):(n.type!==e.string8&&n.type!==e.string16&&n.type!==e.string||i instanceof Uint8Array&&i.forEach((function(e,n){return t.view.setUint8(n+t.byteOffset,e)})),r=i),r}function p(t,n){var i=0;return t.type===e.int8||t.type===e.uint8||t.type===e.boolean?i=1:t.type===e.int16||t.type===e.uint16?i=2:t.type===e.int32||t.type===e.uint32||t.type===e.float32?i=4:t.type===e.string8||t.type===e.string16||t.type===e.string?i=n instanceof Uint8Array?n.byteLength:t.type===e.string8?1:t.type===e.string16?2:4:t.type===e.float64&&(i=8),i}function u(t,n,i){var s,l,a,p,c;if(r(n)){c=[];for(var v=y(t,{type:null!==(l=null===(s=n[1])||void 0===s?void 0:s.lengthType)&&void 0!==l?l:e.uint32},i),b=null!==(p=null===(a=n[1])||void 0===a?void 0:a.unpackCallback)&&void 0!==p?p:null,g=0;g<(f(v)?v:0);g++){var O=u(t,n[0],i);b?null!=(O=b(O,c))&&c.push(O):c.push(O)}}else o(n)?c=y(t,n,i):(c={},Object.keys(n).forEach((function(e){var r=n[e];if(o(r))if(r.compress){var f=y(t,r,i);c[e]=r.compress.unpack(f)}else c[e]=y(t,r,i);else c[e]=u(t,r,i)})));return c}function y(t,n,i){var r,o=0;if(n.type===e.uint8)r=i.view.getUint8(i.byteOffset),o=1;else if(n.type===e.int8)r=i.view.getInt8(i.byteOffset),o=1;else if(n.type===e.boolean)r=0!==i.view.getInt8(i.byteOffset),o=1;else if(n.type===e.uint16)r=i.view.getUint16(i.byteOffset),o=2;else if(n.type===e.int16)r=i.view.getInt16(i.byteOffset),o=2;else if(n.type===e.uint32)r=i.view.getUint32(i.byteOffset),o=4;else if(n.type===e.int32)r=i.view.getInt32(i.byteOffset),o=4;else if(n.type===e.float32)r=i.view.getFloat32(i.byteOffset),o=4;else if(n.type===e.float64)r=i.view.getFloat64(i.byteOffset),o=8;else if(n.type===e.string8||n.type===e.string16||n.type===e.string){o=p(n);var s=void 0,l=void 0;n.type===e.string8?(o+=s=i.view.getUint8(i.byteOffset),l=i.byteOffset+1):n.type===e.string16?(o+=s=i.view.getUint16(i.byteOffset),l=i.byteOffset+2):(o+=s=i.view.getUint32(i.byteOffset),l=i.byteOffset+4);var a=l+s;r=c(t.slice(l,a))}return f(n.multiplier)&&f(r)&&(r/=n.multiplier),i.byteOffset+=o,r}exports.pack=function(e,t,n){void 0===n&&(n={});var i,r=n.sharedBuffer,f=n.returnCopy,o=void 0!==f&&f,l=n.freeBytes,a=void 0===l?0:l,p=n.bufferSizeInBytes,u=null!=p?p:exports.calculateBufferSize(e,t);return s(e,t,{buffer:i=void 0!==r?r:new ArrayBuffer(u+a),byteOffset:0,callStack:[],view:new DataView(i),onErrorCallback:n.onErrorCallback}),void 0!==r&&o?i.slice(0,u):i},exports.unpack=function(e,t){return u(e,t,{byteOffset:0,view:new DataView(e)})};var c,v,b=function(e){return function(t){return e.decode(t)}};"function"==typeof TextDecoder&&(v=new TextDecoder,c=b(v));var g,O,d=function(e){return function(t){return e.encode(t)}};"function"==typeof TextEncoder&&(O=new TextEncoder,g=d(O)),exports.setTextHandler=function(e){g=d(e),c=b(e)};var w={pack:exports.pack,unpack:exports.unpack,utils:{setTextHandler:exports.setTextHandler,calculateBufferSize:exports.calculateBufferSize,Types:e}};exports.default=w;
