"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.setTextHandler=exports.unpack=exports.pack=exports.Types=void 0;var t,e=function(t){return"boolean"==typeof t},n=function(t){return null!==t&&"object"==typeof t},r=function(t){return"object"==typeof t&&Array.isArray(t)},i=function(t){return r(t)&&(1===t.length||2===t.length)},f=function(t){return"number"==typeof t};!function(t){t.int8="int8",t.uint8="uint8",t.int16="int16",t.uint16="uint16",t.int32="int32",t.uint32="uint32",t.float32="float32",t.float64="float64",t.boolean="boolean",t.string8="string8",t.string16="string16",t.string="string"}(t=exports.Types||(exports.Types={}));var o=function(t){return"string"==typeof t.type};var s=function(o,l,p){var a,v;if(void 0===p&&(p=0),r(o)&&i(l)){var c={type:null!==(v=null===(a=l[1])||void 0===a?void 0:a.lengthType)&&void 0!==v?v:t.uint32};p+=y(c,o.length),o.length>0&&(p+=s(o[0],l[0])*o.length)}else Object.keys(l).forEach((function(t){var r=o[t],i=l[t];if(n(r))p+=s(r,i);else if(f(r)||e(r))p+=y(i,r);else if("string"==typeof r){var a=b(r),v=u(i.type);p+=y({type:v},a.byteLength),p+=a.byteLength}}));return p},u=function(e){return e===t.string8?t.uint8:e===t.string16?t.uint16:t.uint32};function l(t,e,n){p({metaValue:e,refObject:t,value:n})}var p=function(e){var n=e.metaValue,r=e.refObject,i=e.value,o=y(n,i),s=new DataView(r.buffer,r.byteOffset,o);return f(n.multiplier)&&f(i)&&(i*=n.multiplier),n.type===t.uint8?(n.preventOverflow&&(i=i<0?0:i>255?255:i),s.setUint8(0,i)):n.type===t.int8?(n.preventOverflow&&(i=i<-128?-128:i>127?127:i),s.setInt8(0,i)):n.type===t.boolean?s.setInt8(0,!1===i?0:1):n.type===t.uint16?(n.preventOverflow&&(i=i<0?0:i>65535?65535:i),s.setUint16(0,i)):n.type===t.int16?(n.preventOverflow&&(i=i<-32768?-32768:i>32767?32767:i),s.setInt16(0,i)):n.type===t.uint32?(n.preventOverflow&&(i=i<0?0:i>4294967295?4294967295:i),s.setUint32(0,i)):n.type===t.int32?(n.preventOverflow&&(i=i<-2147483648?-2147483648:i>2147483647?2147483647:i),s.setInt32(0,i)):n.type===t.float32?s.setFloat32(0,i):n.type===t.float64?s.setFloat64(0,i):n.type!==t.string8&&n.type!==t.string16&&n.type!==t.string||i instanceof Uint8Array&&i.forEach((function(t,e){return s.setUint8(e,t)})),o};function y(e,n){var r=0;if(e.type===t.int8||e.type===t.uint8||e.type===t.boolean)r=1;else if(e.type===t.int16||e.type===t.uint16)r=2;else if(e.type===t.int32||e.type===t.uint32||e.type===t.float32)r=4;else if(e.type===t.string8||e.type===t.string16||e.type===t.string)r=n instanceof Uint8Array?n.byteLength:e.type===t.string8?1:e.type===t.string16?2:4;else{if(e.type!==t.float64)throw Error("Unknown type: "+e.type);r=8}return r}function a(e,n,r){var i,o=y(n),s=new DataView(e,r,o);if(n.type===t.uint8)i=s.getUint8(0);else if(n.type===t.int8)i=s.getInt8(0);else if(n.type===t.uint16)i=s.getUint16(0);else if(n.type===t.int16)i=s.getInt16(0);else if(n.type===t.uint32)i=s.getUint32(0);else if(n.type===t.int32)i=s.getInt32(0);else if(n.type===t.float32)i=s.getFloat32(0);else if(n.type===t.float64)i=s.getFloat64(0);else if(n.type===t.boolean)i=0!==s.getInt8(0);else{if(n.type!==t.string8&&n.type!==t.string16&&n.type!==t.string)throw Error("Unknown metaValue.type "+n);var u=void 0,l=void 0;n.type===t.string8?(o+=u=s.getUint8(0),l=r+1):n.type===t.string16?(o+=u=s.getUint16(0),l=r+2):(o+=u=s.getUint32(0),l=r+4);var p=l+u;i=v(e.slice(l,p))}return f(n.multiplier)&&f(i)&&(i/=n.multiplier),{value:i,byteOffset:r+o}}exports.pack=function(o,p,a){void 0===a&&(a={});var v,c=a.sharedBuffer,g=a.returnCopy,d=void 0!==g&&g,O=a.freeBytes,h=void 0===O?0:O,x=s(o,p);return function o(s,p,a){var v,c;if(r(s)&&i(p)){var g={type:null!==(c=null===(v=p[1])||void 0===v?void 0:v.lengthType)&&void 0!==c?c:t.uint32};l(a,g,s.length),a.byteOffset+=y(g,s.length),s.forEach((function(t){o(t,p[0],a)}))}else Object.keys(p).forEach((function(t){var r=s[t],i=p[t];if(n(r))o(r,i,a);else if(f(r)||e(r))l(a,i,r),a.byteOffset+=y(i,r);else if("string"==typeof r){var v=b(r),c={type:u(i.type)};l(a,c,v.byteLength),a.byteOffset+=y(c,v.byteLength),l(a,i,v),a.byteOffset+=v.byteLength}}))}(o,p,{byteOffset:0,buffer:v=void 0!==c?c:new ArrayBuffer(x+h)}),void 0!==c&&d?v.slice(0,x):v},exports.unpack=function(e,n){return function e(n,r,f){var s,u,l,p,y;if(i(r)){y=[];var v=a(n,{type:null!==(u=null===(s=r[1])||void 0===s?void 0:s.lengthType)&&void 0!==u?u:t.uint32},f.byteOffset),c=v.value,g=v.byteOffset;f.byteOffset=g;for(var b=null!==(p=null===(l=r[1])||void 0===l?void 0:l.unpackCallback)&&void 0!==p?p:null,d=0;d<c;d++){var O=e(n,r[0],f);b?null!=(O=b(O))&&y.push(O):y.push(O)}}else if(y={},o(r)){var h=a(n,r,f.byteOffset),x=h.value;g=h.byteOffset,f.byteOffset=g,y=x}else Object.keys(r).forEach((function(t){if(o(r[t])){var i=a(n,r[t],f.byteOffset),s=i.value,u=i.byteOffset;f.byteOffset=u,y[t]=s}else{var l=e(n,r[t],f);y[t]=l}}));return y}(e,n,{byteOffset:0})};var v,c,g=function(t){return function(e){return t.decode(e)}};"function"==typeof TextDecoder&&(c=new TextDecoder,v=g(c));var b,d,O=function(t){return function(e){return t.encode(e)}};"function"==typeof TextEncoder&&(d=new TextEncoder,b=O(d)),exports.setTextHandler=function(t){b=O(t),v=g(t)};var h={pack:exports.pack,unpack:exports.unpack,setTextHandler:exports.setTextHandler,Types:t};exports.default=h;
